description: "The default job for G2 ruby projects"
parameters:
  default-branch:
    description: "The default github branch"
    type: string
    default: "main"
  bundler-version:
    description: "The Bundler version to install"
    type: string
    default: ""
  always-run-on-branch:
    default: ''
    description: The branch to always run the steps on
    type: string
  base-branch:
    default: master
    description: The branch against which to check against. This can also be a commit SHA
    type: string
  pattern:
    default: .*
    description: >
      The regex to match files against. The command uses grep to search file
      names.

      If you want to enforce starting with use ^. For checking if files in src/
      or lib/ were modified,

      the pattern to use would be ^src.*|^lib.*
    type: string
  steps-to-run:
    default: []
    description: The steps to run if the files mentioned are modified
    type: steps
  test-reporter-tag:
    description: "The tag for the CodeClimate test reporter to download"
    type: string
    default: "latest"
  elasticsearch:
    description: "The `elasticsearch` Docker image version tag."
    type: string
    default: "7.8.0"
  postgres:
    description: "The `postgres` Docker image version tag."
    type: string
    default: "latest"
  psql:
    description: "Does psql need to be installed"
    type: boolean
    default: false
  psql-version:
    description: "What version of PostgreSQL Client needs to be installed?"
    type: string
    default: postgresql-client-12
  setup-database:
    description: "Do we need to run database migrations?"
    type: boolean
    default: true
  redis:
    description: "The `redis` Docker image version"
    type: string
    default: "latest"
  ruby:
    description: "The `circleci/ruby` Docker image version tag."
    type: string
    default: "latest"
  setup-monorepo:
    description: "Is this a monorepo setup?"
    type: boolean
    default: false
  monorepo-dir:
    description: "The project directory path for monorepo setupt"
    type: string
    default: "."
executor:
  name: default
  ruby: << parameters.ruby >>
  redis: << parameters.redis >>
  postgres: << parameters.postgres >>
  elasticsearch: << parameters.elasticsearch >>
steps:
  - checkout
  - run-if-modified:
      always-run-on-branch: << parameters.default-branch >>
      base-branch: << parameters.default-branch >>
      pattern: << parameters.pattern >>
      steps-to-run:
        - when:
            condition: << parameters.setup-monorepo >>
            steps:
              - run: cd << parameters.monorepo-dir >>
        - load-cache
        - install-deps:
            bundler-version: << parameters.bundler-version >>
        - save-cache
        - when:
            condition: << parameters.setup-database >>
            steps:
              - setup-database:
                  psql: << parameters.psql >>
                  psql-version: << parameters.psql-version >>
        - install-cc-test-reporter:
            tag: << parameters.test-reporter-tag >>
        - cc-before-build
        - run-tests
        - cc-after-build
