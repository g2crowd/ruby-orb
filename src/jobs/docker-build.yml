description: "The job for building dockerize ruby projects"
parameters:
  always-run-on-branch:
    default: ''
    description: The branch to always run the steps on
    type: string
  base-branch:
    default: master
    description: The branch against which to check against. This can also be a commit SHA
    type: string
  pattern:
    default: .*
    description: >
      The regex to match files against. The command uses grep to search file
      names.

      If you want to enforce starting with use ^. For checking if files in src/
      or lib/ were modified,

      the pattern to use would be ^src.*|^lib.*
    type: string
  steps-to-run:
    default: []
    description: The steps to run if the files mentioned are modified
    type: steps
  aws-ecr-account-url:
    description: The URL for your private registry
    type: string
  aws-ecr-repo-name:
    description: The name of the ECR repository
    type: string
  tag-with-branch-name:
    description: Tag with current branch name and for main branch use commit hash
    type: boolean
    default: true
  docker-tag-prefix:
    default: ''
    description: The URL for your private registry
    type: string
  default-branch:
    default: main
    description: The name of the default github branch
    type: string
  dockerfile:
    default: Dockerfile
    description: Name of dockerfile to use. Defaults to Dockerfile.
    type: string
  docker-context:
    default: .
    description: Path of the docker context
    type: string
  extra-build-args:
    default: ''
    description: >
      Extra flags to pass to docker build. For examples, see
      https://docs.docker.com/engine/reference/commandline/build
    type: string
  path:
    default: .
    description: >-
      Path to the directory containing your Dockerfile and build context.
      Defaults to . (working directory).
    type: string
  executor-image:
    default: 'ubuntu-2004:202010-01'
    type: string
  use-docker-layer-caching:
    default: false
    type: boolean
executor:
  name: docker
  image: << parameters.executor-image >>
  use-docker-layer-caching: << parameters.use-docker-layer-caching >>
steps:
  - checkout
  - run-if-modified:
      always-run-on-branch: << parameters.default-branch >>
      base-branch: << parameters.default-branch >>
      pattern: << parameters.pattern >>
      steps-to-run:
        - install-aws-cli
        - aws-ecr-login:
            aws-ecr-account-url: <<parameters.aws-ecr-account-url>>
        - build-and-push-image:
            default-branch: <<parameters.default-branch>>
            docker-tag-prefix: <<parameters.docker-tag-prefix>>
            tag-with-branch-name: <<parameters.tag-with-branch-name>>
            aws-ecr-account-url: <<parameters.aws-ecr-account-url>>
            aws-ecr-repo-name: <<parameters.aws-ecr-repo-name>>
            dockerfile: <<parameters.dockerfile>>
            extra-build-args: <<parameters.extra-build-args>>
            path: <<parameters.path>>
            docker-context: <<parameters.docker-context>>
